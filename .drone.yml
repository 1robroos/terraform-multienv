kind: pipeline
type: docker
name: terraform-infrastructure

environment:
  ### -----------------------
  ### Available in all steps, change app_name to your app_name
  TF_VAR_app_name: tfmultienv
  AWS_REGION: eu-west-1
  ### -----------------------

steps:
  - name: prepare-backend
    when:
      branch:
        - dev
        - stg
        - prd
        - feature/*
    image: xueshanf/awscli:alpine-3.11
    environment:
      AWS_ACCESS_KEY_ID:
        from_secret: aws_access_key_id_${DRONE_BRANCH}
      AWS_SECRET_ACCESS_KEY:
        from_secret: aws_secret_access_key_${DRONE_BRANCH}
    commands:
      - bash scripts/prepare-backend.sh
  - name: prepare-files-folders
    depends_on:
      - prepare-backend
    when:
      branch:
        - dev
        - stg
        - prd
        - feature/*
    image: ubuntu:18.04
    commands:
      - bash scripts/prepare-files-folders.sh

  - name: terraform-apply
    when:
      branch:
        - dev
        - stg
        - prd
        - feature/*
    depends_on:
      - prepare-files-folders
    image: unfor19/drone-terraform:dev
    environment:
      AWS_ACCESS_KEY_ID:
        from_secret: aws_access_key_id_${DRONE_BRANCH}
      AWS_SECRET_ACCESS_KEY:
        from_secret: aws_secret_access_key_${DRONE_BRANCH}
    settings:
      actions:
        - validate
        - plan
        - apply
      root_dir: ${DRONE_BRANCH}/
      vars:
        environment: ${DRONE_BRANCH}
